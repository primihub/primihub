version: '3'
services:
  node0:
    image: ${REGISTRY:-docker.io}/primihub/primihub-node:${TAG:-latest}
    restart: "always"
    container_name: primihub-node0
    ports:
      - "50050:50050"
    volumes:
      - ./config:/app/config
      - ./data:/data
    entrypoint:
      - "/bin/bash"
      - "-c"
      - "./primihub-node --service_port=50050  --node_id=node0 --config=/app/config/primihub_node0.yaml"
    depends_on:
      - meta0

  node1:
    image: ${REGISTRY:-docker.io}/primihub/primihub-node:${TAG:-latest}
    restart: "always"
    container_name: primihub-node1
    ports:
      - "50051:50051"
    volumes:
      - ./config:/app/config
      - ./data:/data
    entrypoint:
      - "/bin/bash"
      - "-c"
      - "./primihub-node --service_port=50051 --node_id=node1 --config=/app/config/primihub_node1.yaml"
    depends_on:
      - meta1

  node2:
    image: ${REGISTRY:-docker.io}/primihub/primihub-node:${TAG:-latest}
    restart: "always"
    container_name: primihub-node2
    ports:
      - "50052:50052"
    volumes:
      - ./config:/app/config
      - ./data:/data
    entrypoint:
      - "/bin/bash"
      - "-c"
      - "./primihub-node --service_port=50052 --node_id=node2 --config=/app/config/primihub_node2.yaml"
    depends_on:
      - meta2

  meta0:
    image: ${REGISTRY:-docker.io}/primihub/primihub-meta:${TAG:-latest}
    restart: "always"
    container_name: primihub-meta0
    # ports:
    #   - "7977:9099"
    # volumes:
    #   - ./data:/data
    entrypoint:
      - "/bin/bash"
      - "-c"
      - | 
       java -jar /applications/fusion-simple.jar --server.port=8088 \
       --grpc.server.port=9099 --db.path=/data/meta_service/node0 \ 
       --collaborate=http://primihub-meta1:8088/,http://primihub-meta2:8088/

  meta1:
    image: ${REGISTRY:-docker.io}/primihub/primihub-meta:${TAG:-latest}
    restart: "always"
    container_name: primihub-meta1
    # ports:
    #   - "7977:9099"
    # volumes:
    #   - ./data:/data
    entrypoint:
      - "/bin/bash"
      - "-c"
      - | 
       java -jar /applications/fusion-simple.jar --server.port=8088 \
       --grpc.server.port=9099 --db.path=/data/meta_service/node1 \ 
       --collaborate=http://primihub-meta1:8088/,http://primihub-meta2:8088/

  meta2:
    image: ${REGISTRY:-docker.io}/primihub/primihub-meta:${TAG:-latest}
    restart: "always"
    container_name: primihub-meta2
    # ports:
    #   - "7977:9099"
    # volumes:
    #   - ./data:/data
    entrypoint:
      - "/bin/bash"
      - "-c"
      - | 
       java -jar /applications/fusion-simple.jar --server.port=8088 \
       --grpc.server.port=9099 --db.path=/data/meta_service/node2 \ 
       --collaborate=http://primihub-meta1:8088/,http://primihub-meta2:8088/

networks:
  primihub_net:
